name: Build Executables
run-name: ${{ github.ref_name }}

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  check-major-change:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    outputs:
      major_changed: ${{ steps.compare-majors.outputs.major_changed }}
      previous_tag: ${{ steps.tags.outputs.previous_tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get current and previous tags
        id: tags
        run: |
          CURRENT_TAG="${GITHUB_REF#refs/tags/}"
          echo "current_tag=$CURRENT_TAG" >> "$GITHUB_OUTPUT"

          PREV_TAG="$(git describe --tags --abbrev=0 "${CURRENT_TAG}^" 2>/dev/null || true)"
          echo "previous_tag=$PREV_TAG" >> "$GITHUB_OUTPUT"

      - name: Compare major versions
        id: compare-majors
        run: |
          CURRENT_TAG="${{ steps.tags.outputs.current_tag }}"
          PREV_TAG="${{ steps.tags.outputs.previous_tag }}"
          echo "Current tag: $CURRENT_TAG"
          echo "Previous tag: $PREV_TAG"

          MAJOR_CHANGED="false"

          if [ -n "$PREV_TAG" ]; then
            CUR_MAJOR="${CURRENT_TAG#v}"
            CUR_MAJOR="${CUR_MAJOR%%.*}"

            PREV_MAJOR="${PREV_TAG#v}"
            PREV_MAJOR="${PREV_MAJOR%%.*}"

            echo "Current major: $CUR_MAJOR"
            echo "Previous major: $PREV_MAJOR"

            if [ "$CUR_MAJOR" != "$PREV_MAJOR" ]; then
              MAJOR_CHANGED="true"
            fi
          else
            MAJOR_CHANGED="true"
          fi

          echo "Major changed: $MAJOR_CHANGED"
          echo "major_changed=$MAJOR_CHANGED" >> "$GITHUB_OUTPUT"

  build-macos:
    needs: check-major-change
    if: needs.check-major-change.outputs.major_changed == 'true'
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Import macOS code signing certificate
        run: |
          echo "$MACOS_CERT_P12" | base64 --decode > cert.p12
          security create-keychain -p "" build.keychain
          security import cert.p12 -k build.keychain -P "$MACOS_CERT_PASSPHRASE" -T /usr/bin/codesign
          security list-keychains -s build.keychain login.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain
          security find-identity -p codesigning -v
        env:
          MACOS_CERT_P12: ${{ secrets.MACOS_CERT_P12 }}
          MACOS_CERT_PASSPHRASE: ${{ secrets.MACOS_CERT_PASSPHRASE }}

      - name: Set version from tag
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          if [[ $VERSION =~ ^[0-9]+\.[0-9]+$ ]]; then
            VERSION="${VERSION}.0"
          fi
          echo "Setting version to $VERSION"
          npm version "$VERSION" --no-git-tag-version --allow-same-version
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Install dependencies
        run: npm ci

      - name: Build macOS
        run: |
          mkdir -p dist
          
          # ARM64 -> arm
          npm run make:mac -- --arch=arm64
          mv "out/make/A0 Launcher.dmg" "dist/a0-launcher-${{ env.VERSION }}-macos-arm.dmg"
          mv "out/make/zip/darwin/arm64/"*.zip "dist/a0-launcher-${{ env.VERSION }}-macos-arm.zip"
          
          # x64 -> x86
          npm run make:mac -- --arch=x64
          mv "out/make/A0 Launcher.dmg" "dist/a0-launcher-${{ env.VERSION }}-macos-x86.dmg"
          mv "out/make/zip/darwin/x64/"*.zip "dist/a0-launcher-${{ env.VERSION }}-macos-x86.zip"
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          CI: "true"
          DEBUG: electron-forge:*

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: dist/*

  build-windows:
    needs: check-major-change
    runs-on: windows-latest
    if: needs.check-major-change.outputs.major_changed == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set version from tag
        shell: bash
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          if [[ $VERSION =~ ^[0-9]+\.[0-9]+$ ]]; then
            VERSION="${VERSION}.0"
          fi
          echo "Setting version to $VERSION"
          npm version "$VERSION" --no-git-tag-version --allow-same-version
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Install dependencies
        run: npm ci

      - name: Build Windows
        shell: bash
        run: |
          mkdir -p dist
          
          # x64 -> x86
          npm run make:win -- --arch=x64
          mv "out/make/squirrel.windows/x64/A0 Launcher-${{ env.VERSION }} Setup.exe" "dist/a0-launcher-${{ env.VERSION }}-windows-x86-setup.exe"
          mv "out/make/squirrel.windows/x64/A0Launcher-${{ env.VERSION }}-full.nupkg" "dist/a0-launcher-${{ env.VERSION }}-windows-x86.nupkg"
          
          # arm64 -> arm
          npm run make:win -- --arch=arm64
          mv "out/make/squirrel.windows/arm64/A0 Launcher-${{ env.VERSION }} Setup.exe" "dist/a0-launcher-${{ env.VERSION }}-windows-arm-setup.exe"
          mv "out/make/squirrel.windows/arm64/A0Launcher-${{ env.VERSION }}-full.nupkg" "dist/a0-launcher-${{ env.VERSION }}-windows-arm.nupkg"
        env:
          DEBUG: electron-forge:*

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: dist/*

  build-linux:
    needs: check-major-change
    runs-on: ubuntu-latest
    if: needs.check-major-change.outputs.major_changed == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set version from tag
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          if [[ $VERSION =~ ^[0-9]+\.[0-9]+$ ]]; then
            VERSION="${VERSION}.0"
          fi
          echo "Setting version to $VERSION"
          npm version "$VERSION" --no-git-tag-version --allow-same-version
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Install dependencies
        run: npm ci

      - name: Install Linux build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm

      - name: Build Linux
        run: |
          mkdir -p dist
          
          # x64 -> x86
          npm run make:linux -- --arch=x64
          mv "out/make/deb/x64/"*.deb "dist/a0-launcher-${{ env.VERSION }}-linux-x86.deb"
          mv "out/make/rpm/x64/"*.rpm "dist/a0-launcher-${{ env.VERSION }}-linux-x86.rpm"
          
          # arm64 -> arm
          npm run make:linux -- --arch=arm64
          mv "out/make/deb/arm64/"*.deb "dist/a0-launcher-${{ env.VERSION }}-linux-arm.deb"
          mv "out/make/rpm/arm64/"*.rpm "dist/a0-launcher-${{ env.VERSION }}-linux-arm.rpm"
        env:
          DEBUG: electron-forge:*

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: dist/*

  upload-to-release:
    needs: [check-major-change, build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    if: always() && startsWith(github.ref, 'refs/tags/') && needs.check-major-change.result == 'success' && !contains(needs.*.result, 'failure') && !contains(needs.*.result, 'cancelled')
    permissions:
      contents: write

    steps:
      - name: Download newly built artifacts
        if: needs.check-major-change.outputs.major_changed == 'true'
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Upload executables to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PREVIOUS_TAG: ${{ needs.check-major-change.outputs.previous_tag }}
          MAJOR_CHANGED: ${{ needs.check-major-change.outputs.major_changed }}
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"
          echo "Processing version: $VERSION"
          
          if [ "$MAJOR_CHANGED" = "false" ] && [ -n "$PREVIOUS_TAG" ]; then
            echo "Minor version change detected (same major). Reusing assets from previous release $PREVIOUS_TAG."
            
            PREV_VERSION="${PREVIOUS_TAG#v}"
            echo "Previous version: $PREV_VERSION"

            mkdir -p prev-assets
            gh release download "$PREVIOUS_TAG" --repo "$GITHUB_REPOSITORY" --dir prev-assets --clobber

            # Re-upload files with renamed version
            shopt -s nullglob
            for file in prev-assets/a0-launcher-*; do
              filename=$(basename "$file")
              # Replace previous version with current version in filename
              new_filename="${filename//$PREV_VERSION/$VERSION}"
              
              echo "Copying $filename -> $new_filename"
              cp "$file" "$new_filename"
              
              echo "Uploading: $new_filename"
              gh release upload "$TAG" "$new_filename" --clobber --repo "$GITHUB_REPOSITORY"
            done
          else
            echo "Major version change or no previous tag. Uploading freshly built artifacts."

            # Upload all files found in artifacts dirs (flattened)
            find artifacts -type f | while read -r file; do
              echo "Uploading: $file"
              gh release upload "$TAG" "$file" --clobber --repo "$GITHUB_REPOSITORY"
            done
          fi
