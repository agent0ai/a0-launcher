name: Build Executables
run-name: ${{ github.ref_name }}

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  check-major-change:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    outputs:
      major_changed: ${{ steps.compare-majors.outputs.major_changed }}
      previous_tag: ${{ steps.tags.outputs.previous_tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get current and previous tags
        id: tags
        run: |
          CURRENT_TAG="${GITHUB_REF#refs/tags/}"
          echo "current_tag=$CURRENT_TAG" >> "$GITHUB_OUTPUT"

          PREV_TAG="$(git describe --tags --abbrev=0 "${CURRENT_TAG}^" 2>/dev/null || true)"
          echo "previous_tag=$PREV_TAG" >> "$GITHUB_OUTPUT"

      - name: Compare major versions
        id: compare-majors
        run: |
          CURRENT_TAG="${{ steps.tags.outputs.current_tag }}"
          PREV_TAG="${{ steps.tags.outputs.previous_tag }}"
          echo "Current tag: $CURRENT_TAG"
          echo "Previous tag: $PREV_TAG"

          MAJOR_CHANGED="false"

          if [ -n "$PREV_TAG" ]; then
            CUR_MAJOR="${CURRENT_TAG#v}"
            CUR_MAJOR="${CUR_MAJOR%%.*}"

            PREV_MAJOR="${PREV_TAG#v}"
            PREV_MAJOR="${PREV_MAJOR%%.*}"

            echo "Current major: $CUR_MAJOR"
            echo "Previous major: $PREV_MAJOR"

            if [ "$CUR_MAJOR" != "$PREV_MAJOR" ]; then
              MAJOR_CHANGED="true"
            fi
          else
            MAJOR_CHANGED="true"
          fi

          echo "major_changed=$MAJOR_CHANGED" >> "$GITHUB_OUTPUT"

  build-macos:
    needs: check-major-change
    if: needs.check-major-change.outputs.major_changed == 'true'
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Import macOS code signing certificate
        run: |
          echo "$MACOS_CERT_P12" | base64 --decode > cert.p12
          security create-keychain -p "" build.keychain
          security import cert.p12 -k build.keychain -P "$MACOS_CERT_PASSPHRASE" -T /usr/bin/codesign
          security list-keychains -s build.keychain login.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain
          security find-identity -p codesigning -v
        env:
          MACOS_CERT_P12: ${{ secrets.MACOS_CERT_P12 }}
          MACOS_CERT_PASSPHRASE: ${{ secrets.MACOS_CERT_PASSPHRASE }}

      - name: Set version from tag
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          if [[ $VERSION =~ ^[0-9]+\.[0-9]+$ ]]; then
            VERSION="${VERSION}.0"
          fi
          echo "Setting version to $VERSION"
          npm version "$VERSION" --no-git-tag-version --allow-same-version

      - name: Install dependencies
        run: npm ci

      - name: Build macOS (DMG and ZIP for arm64 and x64)
        run: |
          npm run make:mac -- --arch=arm64
          npm run make:mac -- --arch=x64
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          CI: "true"
          DEBUG: electron-forge:*

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: out/make/**/*



  build-windows:
    needs: check-major-change
    runs-on: windows-latest
    if: needs.check-major-change.outputs.major_changed == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set version from tag
        shell: bash
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          if [[ $VERSION =~ ^[0-9]+\.[0-9]+$ ]]; then
            VERSION="${VERSION}.0"
          fi
          echo "Setting version to $VERSION"
          npm version "$VERSION" --no-git-tag-version --allow-same-version

      - name: Install dependencies
        run: npm ci

      - name: Build Windows (Squirrel for x64 and arm64)
        run: |
          npm run make:win -- --arch=x64
          npm run make:win -- --arch=arm64
        env:
          DEBUG: electron-forge:*

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: out/make/**/*

  build-linux:
    needs: check-major-change
    runs-on: ubuntu-latest
    if: needs.check-major-change.outputs.major_changed == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set version from tag
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          if [[ $VERSION =~ ^[0-9]+\.[0-9]+$ ]]; then
            VERSION="${VERSION}.0"
          fi
          echo "Setting version to $VERSION"
          npm version "$VERSION" --no-git-tag-version --allow-same-version

      - name: Install dependencies
        run: npm ci

      - name: Install Linux build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm

      - name: Build Linux (DEB and RPM for x64 and arm64)
        run: |
          npm run make:linux -- --arch=x64
          npm run make:linux -- --arch=arm64
        env:
          DEBUG: electron-forge:*

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: out/make/**/*

  upload-to-release:
    needs: [check-major-change, build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    if: always() && startsWith(github.ref, 'refs/tags/') && needs.check-major-change.result == 'success' && !contains(needs.*.result, 'failure') && !contains(needs.*.result, 'cancelled')
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        if: needs.check-major-change.outputs.major_changed == 'true'
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        if: needs.check-major-change.outputs.major_changed == 'true'
        run: ls -la artifacts/

      - name: List all files recursively
        if: needs.check-major-change.outputs.major_changed == 'true'
        run: find artifacts -type f

      - name: Rename artifacts for consistent naming
        if: needs.check-major-change.outputs.major_changed == 'true'
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"
          echo "Renaming artifacts for version: $VERSION"

          mkdir -p release-files

          function process_files {
            local pattern=$1
            local ext=$2
            local os=$3
            local search_path=$4
            
            find "$search_path" -name "$pattern" | while read -r src; do
              echo "Processing $src"
              local arch=""
              if [[ "$src" == *"arm64"* ]] || [[ "$src" == *"aarch64"* ]]; then
                arch="arm64"
              elif [[ "$src" == *"x64"* ]] || [[ "$src" == *"amd64"* ]] || [[ "$src" == *"x86_64"* ]]; then
                arch="x64"
              fi

              if [[ -n "$arch" ]]; then
                local suffix=""
                if [[ "$os" == "windows" ]] && [[ "$ext" == ".exe" ]]; then
                  suffix="-setup"
                fi
                
                local dest="release-files/a0-launcher-${VERSION}-${os}-${arch}${suffix}${ext}"
                echo "Copying $src to $dest"
                cp "$src" "$dest"
              else
                echo "Skipping $src (unknown architecture)"
              fi
            done
          }

          # macOS files
          process_files "*.dmg" ".dmg" "macos" "artifacts/macos-build"
          process_files "*.zip" ".zip" "macos" "artifacts/macos-build"

          # Windows files
          process_files "*.exe" ".exe" "windows" "artifacts/windows-build"
          process_files "*.nupkg" ".nupkg" "windows" "artifacts/windows-build"

          # Linux files
          process_files "*.deb" ".deb" "linux" "artifacts/linux-build"
          process_files "*.rpm" ".rpm" "linux" "artifacts/linux-build"

          echo "Release files:"
          ls -la release-files/

      - name: Upload executables to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PREVIOUS_TAG: ${{ needs.check-major-change.outputs.previous_tag }}
          MAJOR_CHANGED: ${{ needs.check-major-change.outputs.major_changed }}
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "Uploading to release: $TAG"

          if [ "$MAJOR_CHANGED" = "false" ] && [ -n "$PREVIOUS_TAG" ]; then
            echo "Minor version change detected (same major). Reusing assets from previous release $PREVIOUS_TAG."

            mkdir -p prev-assets
            gh release download "$PREVIOUS_TAG" --repo "$GITHUB_REPOSITORY" --dir prev-assets --clobber

            # Re-upload only files starting with a0-launcher-
            shopt -s nullglob
            for file in prev-assets/a0-launcher-*; do
              echo "Re-uploading previous asset: $file"
              gh release upload "$TAG" "$file" --clobber --repo "$GITHUB_REPOSITORY"
            done
          else
            echo "Major version change or no previous tag. Uploading freshly built artifacts."

            for file in release-files/*; do
              echo "Uploading: $file"
              gh release upload "$TAG" "$file" --clobber --repo "$GITHUB_REPOSITORY"
            done
          fi
